{% extends 'base.html' %}
{% load static %}
{% load util %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/queue.css' %}">    

<!--  To make the tabs toggleable, add the data-toggle="tab" attribute to each link. Then add a .tab-pane class with a unique ID for every tab and wrap them inside a div element with class .tab-content.  -->
<div class="container" style="margin-top: 105px;">
    <div class="card">
        <div class="card-header">

        <div class="alert alert-danger fadein server-error" style="display: none;" role="alert"></div>

        <div class="alert alert-danger fadein danger-error" style="display: none;" role="alert"></div>

        <div class="alert alert-success fadein" style="display: none;" role="alert"></div>

            <ul class="nav nav-tabs networks sticky-top mt-5">

            {% for network in rc.queues %}
                <li class="nav-item" {% if network.count == 0 %} hidden{% endif %}>
                    <a class="nav-link{% if network.activeNet %} active{% endif %}"
                    {% if network.count != 0 %} 
                        data-toggle="tab" 
                        href="#tab{{ network.name }}"
                    {% endif %}>
                        {{ network.name }}
                    </a>
                </li>
            {% endfor %}
            </ul>

            <div class="tab-content">
            {% for network in rc.queues %}
                <div id="tab{{ network.name }}" class="tab-pane container {% if network.activeNet %} active{% else %} {% if forloop.counter0 == 0 %}{% if not rc.easterEgg %}active {% else %} fade{% endif %}{% endif %}{% endif %}">
                {% if network.count == 0 %}
                    <h6>Wow, you cleared the queue! Have a cookie and some words of wisdom.</h6>
                    <img src="{% static 'img/cookie.png' %}" class="cookie" alt="Cookie" />    
                    {{ rc.empty }}

                {% else %}
                    <div id="network-header" class="nav sticky-top network-header">
                        
                        <div class="pending-info">
                            Pending Requests: {{ network.pending.count }} ({{network.file_count.files_in_dataset}} Files)
                            <br />
                            {% for lp in network.last_pull %}
                            <span class="last-pull-info">Last pull created: 
                                <span class="date-pulled">
                                    {{ lp.date_pulled|date:'db'|upper }} @ {{ lp.date_pulled|time:'Hi' }}
                                </span> 
                                by <span class="user-pulled">
                                    {{ lp.user_pulled__username }}
                                </span>
                            </span>
                            {% endfor %}
                        </div>

                        <div class="pull-button-group">
                            <a href="#" class="btn btn-warning request-encrypt">Encrypt Files</a>
                            <a href="#" class="btn btn-danger request-reject">Reject Files</a>
                            <button class="btn btn-primary pull-button{% if network.pending.count == 0 %} disabled{% endif %}" id="pull{{network.name}}">Create {{ network.name }} Pull</button> 
                            <button class="btn btn-warning pull-button centcom{% if network.centcom.count == 0 %} disabled{% endif %}" id="pull{{network.name}}">Pull only Centcom</button> 

                            

                        {% if network.last_pull.count > 0 %}
                            {% for lp in network.last_pull %}
                                <a class="btn btn-primary download-button" id="dl{{network.name}}"
                                    href="getPull/{{ network.name }}_{{ lp.pull_number }} {{lp.date_pulled|date:"dM"}} {{lp.date_pulled|time:"Hi"}}.zip">Download Current {{ network.name }} Zip</a>
                                {% endfor %}
                        {% else %}
                            <a class="btn btn-primary download-button" id="dl{{network.name}}" href="#" hidden></a>
                        {% endif %}
                        </div>
                    </div>

                    <form class="queue-form">
                    <table width="100%" border="0" cellpadding="5" cellspacing="5">
                        <colgroup>
                            <col width="20%" />
                            <col />
                            <col width="20%" />
                        </colgroup>
                        {% for request in network.q %}
			<tr class="request-header {% if request.pull != None %} pending{% endif %} {% if request.centcom_pull %}centcom{% endif %}" request_hash="{{request.request_hash}}">
                            <td><a href="{% url 'transfer-request' request.request_id %}">{%if request.is_centcom%}<strong>{%endif%}{{ request.user }}{%if request.is_centcom%} &#x1f42a;</strong>{%endif%}</a></td> <!-- link to request view -->
                            <td class="request-comments"> 
				{% if request.is_dupe %}<a href="#" class="btn btn-info show-dupe" request_hash="{{request.request_hash}}">Show Duplicates</a> {% else %}{% endif %}
				{% if request.comments != "" or request.destFlag %}<a href="#" class="btn btn-primary comments info-hide">Show Request Info</a> {% else %}{% endif %}
				</td>
                            <td class="request-submitted">Submitted: {{ request.date_created|date:'db'|upper }} @ {{ request.date_created|time:'Hi' }}</td>
                        </tr>

                        {% if request.comments != "" %}
                        <tr class="request-header{% if request.pull != None %} pending{% endif %}">
                            <td colspan="3" class="req-info comments-text"><div>
                            Comments: {{ request.comments|linebreaksbr }}
                            </div></td>
                        </tr>
                        {% endif %}

                        <!-- only shows warnings when destFlag is true, later requests will need to have a general warning flag to know when to display and use the specific warning flags to render text -->
                        {% if request.destFlag %}
                        <tr class="request-header{% if request.pull != None %} pending{% endif %}">
                            <td colspan="3" class="req-info warnings"><div>
                                Warnings: 
                                {% if request.destFlag %}Submitter is not the primary destination{% endif %}
                                
                                </div></td>
                        </tr>
                        {% endif %}
                        

                        {% for file in request.files.all %}
                        <tr class="{% if request.pull != None %}pending {% endif %}{% if file.rejection_reason != None %}rejected {% endif %}">
                            <td>
                                <input type="checkbox" name="fileSelection" id="chk_{{ file.file_id }}" request_id="{{ request.request_id }}" request_email="{{ request.user.email }}" file_name="{{ file }}" {% if file.rejection_reason != None %} rejected {% else %} not-rejected {% endif %} hidden/>
                                <!-- Show encrypt flag? -->
                                {% if file.is_pii or file.is_centcom_info %}
                                <span title="PII: {{ file.is_pii }}&#10;CENTCOM Info: {{ file.is_centcom_info }}">🔒</span>
                                {% endif %}
                            </td>
                            <td colspan="2"><a title="{{ file }}" href="getFile/{{file.file_object}}">{{ file }}</a></td>
                        </tr>
                        {% endfor %}
                        <!-- end files -->
                        {% if not forloop.last %}<tr class="spacing"><td colspan="3">&nbsp;</td></tr>{% endif %}
                        {% endfor %}
                        <!-- end requests -->
                    </table>
                    </form>

                {% endif %}
                </div>
            {% endfor %}
            </div>

        </div> <!-- END card-header -->
    </div><!-- END card -->
</div> <!-- END container -->

<div id="reject-form" title="Reject File(s)">
    <form>
        <div class="form-group">
            <label for="reason">Rejection Reason: </label>
            <select name="reason" class="form-control">
                <option value=""></option>
                {% for r in rc.rejections %}
                <option value="{{ r.rejection_id }}" data-subject="{{ r.subject }}" data-text="{{ r.text }}">{{ r.name }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

{% include 'partials/_forceReloadForm.html' %}
<script src="{% static 'js/notification.js' %}"></script>
<script src="{% static 'js/queue.js' %}"></script>
{% endblock %}
    